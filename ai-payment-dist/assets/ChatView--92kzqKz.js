import{l as R,v as D,C as L}from"./lodash-UDUmCz0B.js";import{C as z}from"./Input-DT45qaCG.js";import{d as b,r as p,v as k,x as A,y as H,c as _,n as W,z as V,a as v,A as F,u as m,o as g,_ as B,B as M,e as w,k as O,C as T,l as S,D as $,G as I,H as C,I as j,p as q,q as U}from"./index-CuJCDeaq.js";import"./el-input-Df9nb35I.js";const G=["src"],J=1920,P=1080,X=b({__name:"Index",props:{iframeSrc:{}},setup(y){const l=y,u=p("scale(1)"),d=p(null),a=R.throttle(()=>{const n=d.value;if(!n)return;const r=n.clientWidth/J,i=n.clientHeight/P,o=Math.min(r,i);u.value=`scale(${o})`},100);return k(()=>l.iframeSrc,()=>{a(),setTimeout(()=>{a()},300)}),A(()=>{window.addEventListener("resize",a),a()}),H(()=>{window.removeEventListener("resize",a)}),(n,r)=>{const i=D;return g(),_("div",{class:W(["iframe-container flex aic jcc",{hasSrc:l.iframeSrc}])},[V((g(),_("div",{class:"iframe-box",ref_key:"iframeBoxRef",ref:d,"element-loading-text":"Loading..."},[v("iframe",{src:l.iframeSrc,frameborder:"0",style:F({transform:m(u)})},null,12,G)])),[[i,!l.iframeSrc]])],2)}}}),Y=B(X,[["__scopeId","data-v-aec429b1"]]),K={class:"chat-page flex aic jcc"},Q={class:"chat-container flex fdc"},Z=b({__name:"ChatView",setup(y){const l=M(),u=O(),d=w(()=>u.query.evn),a=w(()=>u.params.chatId);let n=[],r=null;const i=p([]),o=p(""),{WalletAddress:E}=T(async({IsConnected:e,Address:s,ChainId:c})=>{e&&c===56&&(i.value=await I(a.value),x(s),o.value=await C())});k(()=>l.ChatHistoryList.find(e=>e.chatId===a.value),async e=>{e&&(i.value=await I(a.value))},{deep:!0,immediate:!0});function x(e=E.value){const s=a.value;if(n.length>0&&n.some(t=>{if(t.readyState===WebSocket.OPEN&&t.url.includes(s))return!0}))return;let c=new WebSocket("wss://ai-test.alchemytech.cc/chat?session="+e+"_"+s);n.push(c),c.onopen=async function(){clearInterval(r),r=null,o.value=await C()},c.onmessage=function(h){try{const t=JSON.parse(h.data);t.type==="VNC_HTML_URL"&&t.message?o.value=t.message:t.type==="ORDER_INFO"&&t.message?(f({text:t.message,sender:"agent",type:"order_info",timeStamp:Date.now()},s),j()):t.type==="FINISH"?(console.log("%cFINISH","font-size:30px;color:#aa5ff0"),o.value=""):f({text:t.message,sender:"agent",type:"text",msgStyle:t.msgStyle,timeStamp:Date.now()},s)}catch(t){console.error("消息解析失败",t)}},c.onclose=function(){console.warn("⚠️ WebSocket 断开，尝试重连中..."),r||(r=setInterval(x,3e3))},c.onerror=function(h){console.error("WebSocket 错误：",h)}}H(()=>{n.length>0&&n.forEach(e=>{e.close()})});const N=async e=>{const s=a.value;f({text:e,sender:"user",type:"text",timeStamp:Date.now()},s);let c=await U({message:e,evn:d.value,chatId:a.value});f({text:c,sender:"agent",type:"text",timeStamp:Date.now()},s)},f=async(e,s)=>{await q({messageObj:e,chatId:s})};return(e,s)=>(g(),_("div",K,[v("div",{class:W(["main-container flex fdc jcsb",{hasSrc:m(o)}])},[v("div",Q,[S(L,{messages:m(i)},null,8,["messages"]),S(z,{isChating:!0,onSubmit:N,onStop:m($),hasSrc:!!m(o)},null,8,["onStop","hasSrc"])])],2),S(Y,{iframeSrc:m(o)},null,8,["iframeSrc"])]))}}),ne=B(Z,[["__scopeId","data-v-38845ee3"]]);export{ne as default};
