import{a4 as M,a5 as f,a6 as x,c as h,o as d,a as m,a7 as B,a8 as R,a9 as S,aa as P,_ as $,ab as K,ac as V,ad as N,ae as D,af as b,ag as A,ah as F,ai as U,aj as O,b as I,ak as J,al as W,am as X}from"./index-DROmgLJS.js";const v=M("ChatHistory",()=>{const t=f("");function e(n){t.value=n}const s=f([]);function a(n){s.value=n}return{ChatHistoryList:s,setChatHistoryList:a,MessagesStorageKey:t,setMessagesStorageKey:e}},{persist:!0});async function Y(t){try{const e=localStorage.getItem(t);return e?JSON.parse(e):[]}catch(e){return console.error("获取聊天记录失败：",e),[]}}async function q(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(s){throw console.error("保存聊天记录失败：",s),s}}function G(){return v().MessagesStorageKey}function T(){return v().ChatHistoryList||[]}function Q(t){return T().some(s=>s.chatId===t)}function Z(){return`messages_${G().slice(-8)||"default"}_chatid`}function z(t){return`${Z()}_${t}`}async function j(t){const e=z(t);return await Y(e)}async function ee(t,e){const s=z(t);await q(s,e)}async function C(t){return await j(t)}async function te(t){return(await C(t)).filter(s=>!s.imgUrl)}async function se(t){const e=T(),s=await C(t),a=[...e],n=a.findIndex(l=>l.chatId===t);n!==-1&&(a[n]={...a[n],messageLength:s.length}),v().setChatHistoryList(a)}const E=new Map;async function ne(t,e){const a=(E.get(t)||Promise.resolve()).then(async()=>{const n=await C(t);(e.sender==="user"||e.sender==="agent")&&n.push(e),await ee(t,n)}).catch(console.error);E.set(t,a),await a}async function ae({messageObj:t,chatId:e}){var s;if(await ne(e,t),Q(e))se(e);else{const a=v(),n=T(),r=await C(e);a.setChatHistoryList([...n,{chatId:e,timeStamp:Date.now(),title:((s=t.text)==null?void 0:s.slice(0,50))||"New chat",messageLength:r.length}])}}const oe={class:"user-message-box flex items-center justify-end"},ie={class:"user-message border-[1.5px] border-black max-w-[80%] py-2.5 px-3.5 rounded-[8px_0_8px_8px] bg-white"},re=x({__name:"User",props:{msg:{}},setup(t){const e=t;return(s,a)=>(d(),h("div",oe,[m("div",ie,[e.msg.type==="text"?(d(),h("div",{key:0,class:S(["msg-"+e.msg.type])},P(e.msg.text),3)):R("",!0)]),B(s.$slots,"timeBox")]))}}),ce={class:"agent-message-box flex"},le=["innerHTML"],ue={key:1},de=["innerHTML"],he={key:2},ge=["innerHTML"],me=x({__name:"Agent",props:{msg:{}},setup(t){const e=t,s=`msg-${e.msg.type}`;return(a,n)=>(d(),h("div",ce,[m("div",{class:S(["agent-message max-w-[80%] py-2.5 px-3.5 rounded-[0px_8px_8px_8px] bg-[#FFCF73]",s])},[e.msg.type==="text"?(d(),h("div",{key:0,innerHTML:e.msg.text},null,8,le)):e.msg.type==="command"?(d(),h("div",ue,[m("div",{class:"command-message",innerHTML:e.msg.text},null,8,de)])):e.msg.type==="status"?(d(),h("div",he,[m("div",{class:"status-message",innerHTML:e.msg.text},null,8,ge)])):R("",!0)]),B(a.$slots,"timeBox",{},void 0,!0)]))}}),ye=$(me,[["__scopeId","data-v-0752d804"]]),fe={class:"chat-window"},pe=x({__name:"Index",props:{messages:{}},setup(t){const e=t,s=f(null),a=f(!0);K(()=>e.messages,()=>{n()},{deep:!0,immediate:!0});function n(){A(()=>{s.value&&a.value&&(s.value.scrollTop=s.value.scrollHeight)})}function r(){if(!s.value)return;const l=s.value,y=20,o=l.scrollHeight-l.scrollTop-l.clientHeight;a.value=o<=y}return V(()=>{s.value&&s.value.addEventListener("scroll",r)}),(l,y)=>(d(),h("div",{class:"chat-messages",ref_key:"chatBox",ref:s,onScroll:r},[m("div",fe,[(d(!0),h(N,null,D(t.messages,(o,u)=>(d(),h("div",{class:S(["message",o.sender,o.type,o.msgStyle]),key:u},[o.sender==="user"?(d(),b(re,{key:0,msg:o},null,8,["msg"])):(d(),b(ye,{key:1,msg:o},null,8,["msg"]))],2))),128))])],544))}}),ve=$(pe,[["__scopeId","data-v-b2e6122a"]]),H=/iPad|iPhone|iPod/.test(navigator.userAgent),k=200,we=t=>{const{containerRef:e,inputRef:s,inputHeight:a,onHeightUpdate:n}=t;let r=null,l=!1,y=window.innerHeight,o=null,u=null,g=null;const c=()=>{s.value&&(a.value=s.value.offsetHeight,e.value&&(e.value.style.paddingBottom=`${a.value}px`),n==null||n())},i=()=>{if(!H){c();return}const L=window.innerHeight;l=y-L>150,u&&clearTimeout(u),u=setTimeout(()=>{c(),u=null},k)},w=L=>{if(!H||!l||!s.value)return;const p=L.target;if(!(s.value.contains(p)||p.closest("textarea")!==null||p.closest("input")!==null||p.tagName==="TEXTAREA"||p.tagName==="INPUT")){const _=document.activeElement;_&&(_.tagName==="TEXTAREA"||_.tagName==="INPUT")&&_.blur()}};return s.value&&(c(),y=window.innerHeight,r=new ResizeObserver(c),r.observe(s.value),H?(window.visualViewport?(window.visualViewport.addEventListener("resize",i),window.visualViewport.addEventListener("scroll",i)):(window.addEventListener("resize",i),o=()=>{g&&clearTimeout(g),g=setTimeout(()=>{y=window.innerHeight,i(),g=null},k)},window.addEventListener("orientationchange",o)),document.addEventListener("touchstart",w,{passive:!0})):window.addEventListener("resize",i)),()=>{u&&(clearTimeout(u),u=null),g&&(clearTimeout(g),g=null),r&&(r.disconnect(),r=null),H?(window.visualViewport?(window.visualViewport.removeEventListener("resize",i),window.visualViewport.removeEventListener("scroll",i)):(window.removeEventListener("resize",i),o&&(window.removeEventListener("orientationchange",o),o=null)),document.removeEventListener("touchstart",w)):window.removeEventListener("resize",i)}},_e={class:"h-full overflow-y-auto bg-[url('@/assets/imgs/chat/bg.png')] bg-no-repeat bg-center bg-[#fffefa] bg-size-[100%_auto] container mx-auto lg:max-w-3xl"},He={class:"p-4 flex flex-col flex-1 overflow-hidden"},xe={class:"container mx-auto p-4 lg:max-w-3xl"},Se=x({__name:"ChatView",setup(t){const e=v(),s=f([]),a=U(),n=F(()=>a.params.chatId);K(()=>e.ChatHistoryList.find(c=>c.chatId===n.value),async c=>{c&&(s.value=await te(n.value))},{deep:!0,immediate:!0});const r=f(null),l=f(null),y=f(96);let o=null;V(()=>{o=we({containerRef:r,inputRef:l,inputHeight:y})}),O(()=>{o&&(o(),o=null)});const u=async(c,i)=>{await ae({messageObj:c,chatId:i})},g=async c=>{const i=n.value;u({text:c,sender:"user",type:"text",timeStamp:Date.now()},i);const w=await X({message:c,chatId:n.value});u({text:w,sender:"agent",type:"text",timeStamp:Date.now()},i)};return(c,i)=>(d(),h("div",_e,[m("div",{ref_key:"containerRef",ref:r,class:"flex flex-col flex-1"},[m("div",He,[I(ve,{messages:J(s)},null,8,["messages"])]),m("div",{ref_key:"inputRef",ref:l,class:"fixed bottom-0 left-0 right-0 z-10 bg-white border-t border-gray-200 pb-[env(safe-area-inset-bottom,0)] lg:border-none"},[m("div",xe,[I(W,{onSubmit:g})])],512)],512)]))}});export{Se as default};
